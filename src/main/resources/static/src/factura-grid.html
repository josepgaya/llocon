<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<dom-module id="factura-grid">
<template>
<style>
iron-data-table {
	height: 100%;
}
iron-data-table .import {
	width: 100%;
	text-align: right;
}
iron-data-table data-table-row[even] {
	background-color: #f6f6f6;
}
paper-button.indigo {
	background-color: var(--paper-indigo-500);
	color: white;
}
a {
    text-decoration: none;
}
</style>
<div style="height: 500px">
	<iron-ajax
		id ="ajaxFactures"
		url="rest/factura/search/findBySubministramentLloguerCodi?lloguerCodi=[[lloguerCodi]]"></iron-ajax>
	<iron-ajax
		id ="ajaxPendent"
		url="factura/importPendent/[[lloguerCodi]]"></iron-ajax>
	<iron-ajax
		id ="ajaxCanviEstat"
		url="factura/"></iron-ajax>
	<iron-data-table id="facturesDatatable" data-source="[[dataSource]]" sort-order="[[defaultSort]]">
		<data-table-column name="Producte">
			<template>[[item.subministrament.producte]]</template>
		</data-table-column>
		<data-table-column name="Número">
			<template>[[item.numero]]</template>
		</data-table-column>
		<data-table-column name="Data">
			<template>[[item.data]]</template>
		</data-table-column>
		<data-table-column name="Import">
			<template><div class="import">[[item.importt]]</div></template>
		</data-table-column>
		<data-table-column name="Estat">
			<template>[[item.estat]]</template>
		</data-table-column>
		<data-table-column>
			<template>
				<paper-button raised class="custom indigo" on-tap="botoEstatClick" id="[[item.id]]">Canviar estat</paper-button>
			</template>
		</data-table-column>
		<data-table-column>
			<template>
				<a href="factura/[[item.id]]/descarregar">
					<paper-button raised class="custom indigo">Descarregar</paper-button>
				</a>
			</template>
		</data-table-column>
	</iron-data-table>
</div>
<h2>
	Pendent: [[totalPendent]] €
	<a href="lloguer/[[lloguerCodi]]/csvPendent">
		<paper-button raised class="custom indigo">CSV Pendents</paper-button>
	</a>
</h2>
</template>
<script>
Polymer({
	is : 'factura-grid',
	properties: {
		lloguerCodi: {
			type: String,
			observer: "canviLloguerCodi"
		},
		totalPendent: Number,
		defaultSort: {
			type: Array,
			value: ["data,desc"]
		},
		dataSource: {
			value: function() {
				var $ajaxFactures = this.$.ajaxFactures;
				return function (params, callback) {
					var getParams = {
						page: params.page,
						size: params.pageSize
					}
					if (params.sortOrder.length > 0) {
						getParams.sort = [];
						for (i = 0; i < params.sortOrder.length; i++) {
							getParams.sort.push(params.sortOrder[i]);
						}
					}
					$ajaxFactures.params = getParams;
					var request = $ajaxFactures.generateRequest();
					request.completes.then(function() {
						callback(request.response._embedded.factura, request.response.page.totalElements);
					}, function() {
						// fail
					});
				}
			}
		}
	},
	ready: function () {
		var request = this.$.ajaxPendent.generateRequest();
		request.completes.then(() => {
			this.totalPendent = request.response;
		});
	},
	botoEstatClick: function (e) {
		var id = e.target.getAttribute('id');
		var $facturesDatatable = this.$.facturesDatatable;
		var $ajaxPendent = this.$.ajaxPendent;
		var thisPendent =  this;
		this.$.ajaxCanviEstat.url = 'factura/' + id + '/canviEstat';
		var request = this.$.ajaxCanviEstat.generateRequest();
		request.completes.then(function() {
			var requestPendent = $ajaxPendent.generateRequest();
			requestPendent.completes.then(() => {
				thisPendent.totalPendent = requestPendent.response;
			});
			$facturesDatatable.clearCache();
		});
	},
	canviLloguerCodi: function (actual, previ) {
		this.$.facturesDatatable.clearCache();
	}
});
</script>
</dom-module>
