<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="submin-grid">
<template>
<style>
iron-data-table {
	height: 100%;
}
iron-data-table .import {
	width: 100%;
	text-align: right;
}
iron-data-table data-table-row[even] {
	background-color: #f6f6f6;
}
paper-button.indigo {
	background-color: var(--paper-indigo-500);
	color: white;
}
</style>
<div style="height: 600px">
	<iron-ajax
		id ="ajaxSubmins"
		url="http://localhost:8080/rest/subministrament"></iron-ajax>
	<iron-ajax
		id="ajaxActualitzar"
		url="subministrament/"></iron-ajax>
	<iron-data-table id="subminsDatatable" data-source="[[dataSource]]" sort-order="[[defaultSort]]">
		<data-table-column name="Lloguer">
			<template>[[item.lloguer.nom]]</template>
		</data-table-column>
		<data-table-column name="Producte">
			<template>[[item.producte]]</template>
		</data-table-column>
		<data-table-column name="Proveidor">
			<template>[[item.connexio.proveidor]]</template>
		</data-table-column>
		<data-table-column name="Contracte">
			<template>[[item.contracteNum]]</template>
		</data-table-column>
		<data-table-column name="Actualització">
			<template><div>[[formatejarData(item.darreraActualitzacio)]]</div></template>
		</data-table-column>
		<data-table-column>
			<template>
				<paper-button raised class="custom indigo" on-tap="botoActualitzarClick" id="[[item.id]]">Actualitzar</paper-button>
			</template>
		</data-table-column>
	</iron-data-table>
	<paper-dialog id="actualitzarDialeg">
		<h2>Actualització de factures <paper-spinner id="actualitzarSpinner" active></paper-spinner></h2>
		<p>[[actualitzarMissatge]]</p>
		<div class="buttons">
			<paper-button dialog-confirm autofocus>Tancar</paper-button>
		</div>
	</paper-dialog>
</div>
</template>
<script>
function padFilter(value, width = 2, z = 0) {
	return (String(z).repeat(width) + String(value)).slice(String(value).length);
}
Polymer({
	is : 'submin-grid',
	properties: {
		actualitzarMissatge: String,
		defaultSort: {
			type: Array,
			value: ["lloguer,asc"]
		},
		dataSource: {
			value: function() {
				var $ajaxSubmins = this.$.ajaxSubmins;
				return function (params, callback) {
					var getParams = {
						page: params.page,
						size: params.pageSize
					}
					if (params.sortOrder.length > 0) {
						getParams.sort = [];
						for (i = 0; i < params.sortOrder.length; i++) {
							getParams.sort.push(params.sortOrder[i]);
						}
					}
					$ajaxSubmins.params = getParams;
					var request = $ajaxSubmins.generateRequest();
					request.completes.then(function() {
						callback(request.response._embedded.subministrament, request.response.page.totalElements);
					}, function() {
						// fail
					});
				}
			}
		}
	},
	formatejarData: function(valor) {
		if (valor) {
			var data = new Date(valor);
			var dataText = 
				padFilter(data.getDate()) + '-' +
				padFilter((data.getMonth() + 1)) + '-' +
				data.getFullYear() + ' ' +
				padFilter(data.getHours()) + ':' +
				padFilter(data.getMinutes()) + ':' +
				padFilter(data.getSeconds());
			return dataText;
		} else {
			return null;
		}
	},
	botoActualitzarClick: function (e) {
		var id = e.target.getAttribute('id');
		var $subminsDatatable = this.$.subminsDatatable;
		var $actualitzarDialeg = this.$.actualitzarDialeg;
		var $actualitzarSpinner = this.$.actualitzarSpinner;
		var thisPendent = this;
		this.$.ajaxActualitzar.url = 'subministrament/' + id + '/actualitzar';
		var request = this.$.ajaxActualitzar.generateRequest();
		thisPendent.actualitzarMissatge = '';
		$actualitzarSpinner.active = true;
		$actualitzarDialeg.open();
		request.completes.then(function() {
			$subminsDatatable.clearCache();
			var facturesNoves = request.response;
			if (facturesNoves.length) {
				thisPendent.actualitzarMissatge = "Hi ha " + facturesNoves.length + " factures noves";
			} else {
				thisPendent.actualitzarMissatge = "No hi ha factures noves";
			}
			$actualitzarSpinner.active = false;
		}, function() {
			$subminsDatatable.clearCache();
			thisPendent.actualitzarMissatge = "L'actualització ha fallat!";
			$actualitzarSpinner.active = false;
		});
	}
});
</script>
</dom-module>
