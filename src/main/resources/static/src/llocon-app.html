<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-styles/default-theme.html">
<link rel="import" href="llocon-cercle.html">
<link rel="import" href="llocon-header-main.html">
<link rel="import" href="llocon-header-lloguer.html">

<link rel="lazy-import" href="llocon-lloguers.html">
<link rel="lazy-import" href="llocon-factures.html">
<link rel="lazy-import" href="llocon-subminis.html">
<link rel="lazy-import" href="llocon-error404.html">

<dom-module id="llocon-app">
<template>
<style>
:host {
}
app-drawer-layout:not([narrow]) [drawer-toggle] {
	display: none;
}
.drawer-list {
	margin: 0 20px;
}
.drawer-list a {
	display: block;
	padding: 0 16px;
	text-decoration: none;
	color: var(--app-secondary-color);
	line-height: 40px;
}
.drawer-list a.iron-selected {
	color: black;
	font-weight: bold;
}
</style>
<app-location route="{{route}}"></app-location>
<app-route
	route="{{route}}"
	pattern="[[rootPattern]]:page"
	data="{{routeData}}"
	tail="{{subroute}}"></app-route>
</app-route>
<app-header-layout>
	<iron-pages
		selected="[[page]]"
		attr-for-selected="name"
		fallback-selection="error404"
		role="main">
		<div name="lloguers">
			<llocon-header-main title="Llocon"></llocon-header-main>
			<llocon-lloguers></llocon-lloguers>
		</div>
		<div name="factures">
			<llocon-header-lloguer
				id="lloconHeaderFactures"
				lloguer-codi="[[lloguerActual]]"
				route="[[subroute]]"></llocon-header-lloguer>
			<llocon-factures id="lloconFactures" lloguer-codi="[[lloguerActual]]"></llocon-factures>
		</div>
		<div name="subminis">
			<llocon-header-lloguer
				id="lloconHeaderSubminis"
				lloguer-codi="[[lloguerActual]]"
				route="[[subroute]]"></llocon-header-lloguer>
			<llocon-subminis id="lloconSubminis" lloguer-codi="[[lloguerActual]]"></llocon-subminis>
		</div>
		<llocon-error404 name="error404"></llocon-error404>
	</iron-pages>
</app-header-layout>
</template>
<script>
class LloconApp extends Polymer.Element {
	static get is() { return 'llocon-app' }
	static get properties() {
		return {
			page: {
				type: String,
				reflectToAttribute: true,
				observer: '_pageChanged',
			},
			rootPattern: String,
			routeData: Object,
			subroute: Object
		};
	}
	static get observers() {
		return [
			'_routePageChanged(routeData.page)',
		];
	}
	constructor() {
		super();
		// Get root pattern for app-route, for more info about `rootPath` see:
		// https://www.polymer-project.org/2.0/docs/upgrade#urls-in-templates
		this.rootPattern = (new URL(this.rootPath)).pathname;
	}
	ready() {
        super.ready();
        this.addEventListener('lloguer-modificat', (e) => this._onLloguerModificat(e));
        //this.addEventListener('canvi-lloguer', (e) => this._onCanviLloguer(e));
	}
	_routePageChanged(page) {
		// Polymer 2.0 will call with `undefined` on initialization.
		// Ignore until we are properly called with a string.
		if (page === undefined) {
			return;
		}
		// If no page was found in the route data, page will be an empty string.
		// Default to 'lloguers' in that case.
		this.page = page || 'lloguers';
		/*/ Close a non-persistent drawer when the page & route are changed.
		if (!this.$.drawer.persistent) {
			this.$.drawer.close();
		}*/
	}
	_pageChanged(page) {
		if (page === 'lloguer') {
			var subPath = this.subroute.path;
			this.lloguerActual = subPath.substring(1, subPath.lastIndexOf('/'));
			this.page = subPath.substring(subPath.lastIndexOf('/') + 1);
		} else {
			if (page === 'factures' || page === 'subminis') {
				this.mostrarCapsaleraApp = false;
				this.mostrarCapsaleraLloguer = true;
			} else {
				this.mostrarCapsaleraApp = true;
				this.mostrarCapsaleraLloguer = false;
			}
			// Load page import on demand. Show 404 page if fails
			var resolvedPageUrl = this.resolveUrl('llocon-' + page + '.html');
			Polymer.importHref(
				resolvedPageUrl,
				null,
				this._showPage404.bind(this),
				true);
		}
	}
	_showPage404() {
		this.page = 'error404';
	}
	_onLloguerModificat(event) {
		this.$.lloconHeaderFactures.refresh();
		this.$.lloconFactures.refresh();
		this.$.lloconHeaderSubminis.refresh();
		if (this.$.lloconSubminis.refresh) {
			this.$.lloconSubminis.refresh();
		}
	}
}
window.customElements.define(LloconApp.is, LloconApp);
</script>
</dom-module>